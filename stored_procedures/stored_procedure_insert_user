use idmdb;

DELIMITER ;; 
DROP PROCEDURE IF EXISTS insert_user;
CREATE PROCEDURE insert_user
( 
	 IN p_username VARCHAR(16),
     IN p_name VARCHAR(32),
     IN p_surname VARCHAR(32),
     IN p_uid INT,
     IN p_gid INT,
     IN p_group_name VARCHAR(32),
     IN p_division VARCHAR(32),
     IN p_creation_date DATE,
     IN p_expiration_date DATE,
     IN p_vpn_expiration_date DATE,
     IN p_email VARCHAR(64)
)  
   BEGIN
   	DECLARE user_idm_lid INT;
	INSERT INTO user_idm (username, name, surname, uid, gid, creation_date, expiration_date, vpn_expiration_date, email)
    VALUES (p_username, p_name, p_surname, p_uid, p_gid, p_creation_date, p_expiration_date, p_vpn_expiration_date, p_email);
    	SET user_idm_lid = LAST_INSERT_ID();
    	INSERT INTO user_group_idm (iduserExt, idgroupExt, dateFrom, type) SELECT user_idm_lid, idgroup, p_creation_date, 0 FROM idmdb.group WHERE name=p_division;	
    	INSERT INTO user_group_idm (iduserExt, idgroupExt, dateFrom, type) SELECT user_idm_lid, idgroup, p_creation_date, 1 FROM idmdb.group WHERE name=p_group_name;
   END
   ;;
