use idmdb;

DELIMITER ;; 
DROP PROCEDURE IF EXISTS update_user_2;
CREATE PROCEDURE update_user_2
( 
	 IN p_iduser_idm INT,
	 IN p_username VARCHAR(16),
     IN p_name VARCHAR(32),
     IN p_surname VARCHAR(32),
     IN p_uid INT,
     IN p_gid INT,
     IN p_group_names VARCHAR(320),
     IN p_creation_date DATE,
     IN p_expiration_date DATE,
     IN p_vpn_expiration_date DATE,
     IN p_email VARCHAR(64),
     IN p_closing_date DATE,
     IN p_mach_user TINYINT
)  
   BEGIN  
    DECLARE update_stmt_rc INT;
    DECLARE group_type INT;
    DECLARE strLen INT DEFAULT 0;
    DECLARE SubStrLen INT DEFAULT 0;
    DECLARE group_name VARCHAR(32);

    SET group_type = !p_mach_user;   
	
    UPDATE user_idm SET username = p_username, name = p_name, surname = p_surname, uid = p_uid, gid = p_gid, creation_date = p_creation_date, expiration_date = p_expiration_date, vpn_expiration_date = p_vpn_expiration_date, email = p_email, closing_date = p_closing_date
    WHERE iduser_idm = p_iduser_idm;
    	
    # exclude FIND_IN_SET from the WHERE clause
    UPDATE user_group_idm AS ug_idm_dst, (SELECT iduser_group_idm, idgroupExt FROM user_group_idm INNER JOIN idmdb.group ON idgroupExt=idgroup WHERE iduserExt = p_iduser_idm AND dateTo IS NULL) AS ug_idm_src
    SET
	ug_idm_dst.dateTo = CURDATE()
    WHERE ug_idm_dst.iduser_group_idm=ug_idm_src.iduser_group_idm;
    SET update_stmt_rc = ROW_COUNT();

    IF(	update_stmt_rc > 0) THEN
    do_this:
        LOOP
	    SET strLen = CHAR_LENGTH(p_group_names);
	    SET group_name = SUBSTRING_INDEX(p_group_names, ',', 1);

	    #IF EXISTS (SELECT * FROM idmdb.group WHERE name=group_name) THEN
                INSERT INTO user_group_idm (iduserExt, idgroupExt, dateFrom, type) SELECT p_iduser_idm, idgroup, CURDATE(), group_type FROM idmdb.group WHERE name=group_name;			
	    #END IF;

            SET SubStrLen = CHAR_LENGTH(SUBSTRING_INDEX(p_group_names, ',', 1)) +2;
            SET p_group_names = MID(p_group_names, SubStrLen, strLen);
	   

            IF p_group_names = '' THEN
                LEAVE do_this;
            END IF;

            IF group_type < 2 THEN
                SET group_type = group_type +1;
            END IF;

        END LOOP do_this;

   END IF;
   END
   ;;
